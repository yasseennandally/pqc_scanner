<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PQC Scanner</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e9eefc;margin:0}
    header{padding:18px 22px;border-bottom:1px solid #1d2a44;background:#0d162a;position:sticky;top:0;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:12px;opacity:.85}
    textarea,input{background:#0f1b33;color:#e9eefc;border:1px solid #243454;border-radius:10px;padding:10px;width:100%}
    textarea{min-height:84px}
    button{background:#4c7dff;border:0;color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#223459}
    button:disabled{opacity:.55;cursor:not-allowed}
    .card{background:#0f1b33;border:1px solid #1f2f50;border-radius:14px;padding:14px}
    .muted{opacity:.8}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid #1b2946;vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;opacity:.8}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .sev-critical{background:#ff3b3b;color:white}
    .sev-high{background:#ff7a3b;color:#1a0d00}
    .sev-medium{background:#ffd23b;color:#201800}
    .sev-low{background:#41d17a;color:#04110a}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
    details{background:#0c162c;border:1px solid #1f2f50;border-radius:12px;padding:10px;margin-top:8px}
    summary{cursor:pointer;font-weight:700}
    pre{background:#071026;border:1px solid #1f2f50;border-radius:10px;padding:10px;overflow:auto}
    .progress{height:10px;background:#091026;border:1px solid #1f2f50;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:#4c7dff;width:0%}
    .tiny{font-size:12px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <div style="font-size:18px;font-weight:800">PQC Scanner</div>
        <div class="muted tiny">TLS crypto inventory + PQC relevance + migration guidance</div>
      </div>
      <div class="tiny muted" id="apiState"></div>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="grid">
    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Run TLS scan</div>

      <div class="row">
        <div style="flex:2;min-width:240px">
          <label>Targets (one per line)</label>
          <textarea id="targets" placeholder="google.com&#10;badssl.com:443&#10;incomplete-chain.badssl.com:443"></textarea>
        </div>

        <div style="flex:1;min-width:220px">
          <label>API Key (optional)</label>
          <input id="apiKey" placeholder="x-api-key header value"/>
          <div class="tiny muted" style="margin-top:6px">Leave empty if PQC_API_KEY not set on backend.</div>
        </div>

        <div style="flex:0 0 auto">
          <button id="btnScan">Start Scan</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="tiny muted" id="scanStatusText">Idle.</div>
        <div class="progress" style="margin-top:8px">
          <div id="progressBar"></div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="secondary" id="btnLoadLatest">Load latest scan</button>
        <button class="secondary" id="btnTLSPlan" disabled>Generate TLS Migration Plan</button>
      </div>

      <div class="tiny muted" style="margin-top:10px">
        The scan auto-polls progress until completed, then loads results automatically.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Recent scans</div>
      <div class="tiny muted" style="margin-bottom:8px">Click Load to view results.</div>
      <div style="max-height:260px;overflow:auto">
        <table id="historyTbl">
          <thead>
          <tr>
            <th style="width:36%">Scan ID</th>
            <th>Status</th>
            <th>Created</th>
            <th>Score</th>
            <th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap">
      <div>
        <div style="font-weight:800">Results</div>
        <div class="tiny muted" id="summaryLine">No results loaded.</div>
      </div>
      <div class="tiny muted mono" id="activeScanId"></div>
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table id="resultsTbl">
        <thead>
        <tr>
          <th>host</th>
          <th>port</th>
          <th>tls</th>
          <th>key</th>
          <th>sig</th>
          <th>expiry</th>
          <th>risk</th>
          <th>PQC</th>
          <th>details</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="font-weight:800;margin-bottom:8px">TLS Migration Plan</div>
    <div class="tiny muted">Produces an ordered checklist based on findings across all endpoints.</div>
    <div id="tlsPlanOut" style="margin-top:10px" class="tiny muted">No plan generated yet.</div>
  </div>

</div>

<script>
  const API_BASE = "http://127.0.0.1:8000";

  function hdrs() {
    const k = document.getElementById("apiKey").value.trim();
    const h = {"Content-Type":"application/json"};
    if (k) h["x-api-key"] = k;
    return h;
  }

  function sevPill(sev) {
    const s = (sev||"LOW").toUpperCase();
    let cls = "sev-low";
    if (s==="CRITICAL") cls="sev-critical";
    else if (s==="HIGH") cls="sev-high";
    else if (s==="MEDIUM") cls="sev-medium";
    return `<span class="pill ${cls}">${s}</span>`;
  }

  function setProgress(pct, text) {
    document.getElementById("progressBar").style.width = `${pct}%`;
    document.getElementById("scanStatusText").textContent = text;
  }

  async function apiGet(path) {
    const res = await fetch(API_BASE + path, {headers: hdrs()});
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function apiPost(path, body) {
    const res = await fetch(API_BASE + path, {method:"POST", headers: hdrs(), body: JSON.stringify(body)});
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  function fmtDate(iso) {
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  async function refreshHistory() {
    try {
      const list = await apiGet("/scans?limit=20");
      const tb = document.querySelector("#historyTbl tbody");
      tb.innerHTML = "";
      for (const row of list) {
        const score = row.summary?.quantum_risk_score ?? "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${row.id}</td>
          <td>${row.status}</td>
          <td class="tiny muted">${fmtDate(row.created_at)}</td>
          <td>${score}</td>
          <td><button class="secondary tiny" data-id="${row.id}">Load</button></td>
        `;
        tb.appendChild(tr);
      }
      tb.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", ()=> loadScan(btn.getAttribute("data-id")));
      });
    } catch(e) {
      // ignore if backend down
    }
  }

  function buildFindingsBlock(findings) {
    if (!findings || findings.length === 0) return `<div class="tiny muted">No findings.</div>`;

    let html = `<details><summary>${findings.length} finding(s)</summary>`;
    for (const f of findings) {
      const sev = (f.severity||"LOW").toUpperCase();
      html += `
        <div style="margin-top:10px">
          ${sevPill(sev)} <span style="font-weight:800">${escapeHtml(f.title||f.id)}</span><br/>
          <span class="mono">${escapeHtml(f.id||"")}</span>
          <span class="muted"> • Fix:</span> ${escapeHtml(f.fix||"")}
          <div class="tiny muted" style="margin-top:6px">
            Confidence: <b>${escapeHtml(f.confidence||"")}</b> — ${escapeHtml(f.confidence_reason||"")}
          </div>
          <pre class="mono">${escapeHtml(JSON.stringify(f.evidence||{}, null, 2))}</pre>
          <div class="tiny muted">${escapeHtml(f.pqc_note||"")}</div>
        </div>
      `;
    }
    html += `</details>`;
    return html;
  }

  function escapeHtml(s) {
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#039;");
  }

  function renderResults(scan) {
    const tb = document.querySelector("#resultsTbl tbody");
    tb.innerHTML = "";

    const sum = scan.summary || {};
    document.getElementById("summaryLine").textContent =
      `Quantum score ${sum.quantum_risk_score ?? ""}/100 (${sum.quantum_risk_level ?? ""}), total=${sum.total ?? ""}, critical=${sum.critical ?? 0}, high=${sum.high ?? 0}, medium=${sum.medium ?? 0}, low=${sum.low ?? 0}`;

    document.getElementById("activeScanId").textContent = `active scan: ${scan.id}`;

    for (const r of (scan.results||[])) {
      const expiry = (r.days_until_expiry==null) ? "" : `${r.days_until_expiry}d`;
      const risk = (r.risk||"").toLowerCase();
      const level = (r.risk_level||"low").toLowerCase();
      const pqc = (r.pqc_relevance||"").toUpperCase();

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.host)}</td>
        <td>${escapeHtml(r.port)}</td>
        <td>${escapeHtml(r.tls_version)}</td>
        <td>${escapeHtml(r.key_detail||"")}</td>
        <td>${escapeHtml(r.sig_algorithm||"")}</td>
        <td>${escapeHtml(expiry)}</td>
        <td>${sevPill(level.toUpperCase())}</td>
        <td>${escapeHtml(pqc)}</td>
        <td>
          <div class="tiny muted">${escapeHtml(r.pqc_recommendation||"")}</div>
          ${buildFindingsBlock(r.findings)}
        </td>
      `;
      tb.appendChild(tr);
    }

    document.getElementById("btnTLSPlan").disabled = false;
  }

  async function loadScan(scanId) {
    const scan = await apiGet(`/scans/${scanId}/results`);
    renderResults(scan);
    window.__ACTIVE_SCAN_ID__ = scanId;
  }

  async function pollProgress(scanId) {
    while (true) {
      const st = await apiGet(`/scans/${scanId}`);
      const p = st.progress || {total:0, done:0, percent:0};
      setProgress(p.percent||0, `Scan ${st.status}: ${p.done}/${p.total} (${p.percent}%)`);

      if (st.status === "completed") {
        const scan = await apiGet(`/scans/${scanId}/results`);
        renderResults(scan);
        return;
      }
      await new Promise(r => setTimeout(r, 600));
    }
  }

  document.getElementById("btnScan").addEventListener("click", async ()=>{
    try {
      const raw = document.getElementById("targets").value.trim();
      const targets = raw.split("\n").map(x=>x.trim()).filter(Boolean);
      if (!targets.length) return alert("Add at least one target.");

      setProgress(0, "Creating scan...");
      const st = await apiPost("/scans", {targets});
      window.__ACTIVE_SCAN_ID__ = st.id;
      await refreshHistory();
      await pollProgress(st.id);
    } catch (e) {
      console.error(e);
      alert("Failed to create scan. Is the backend running and API key correct?");
      setProgress(0, "Idle.");
    }
  });

  document.getElementById("btnLoadLatest").addEventListener("click", async ()=>{
    const list = await apiGet("/scans?limit=1");
    if (!list.length) return alert("No scans yet.");
    await loadScan(list[0].id);
  });

  document.getElementById("btnTLSPlan").addEventListener("click", async ()=>{
    try {
      const id = window.__ACTIVE_SCAN_ID__;
      if (!id) return alert("No active scan loaded.");
      const plan = await apiGet(`/scans/${id}/migration-plan`);
      const items = plan.items || [];
      if (!items.length) {
        document.getElementById("tlsPlanOut").innerHTML = `<div class="tiny muted">(No plan items returned)</div>`;
        return;
      }
      let html = "";
      for (const it of items) {
        html += `
          <details>
            <summary>${sevPill(it.severity)} <span style="font-weight:800">${escapeHtml(it.title)}</span> <span class="mono">${escapeHtml(it.rule_id)}</span></summary>
            <div style="margin-top:10px" class="tiny">
              <div><b>Fix:</b> ${escapeHtml(it.fix||"")}</div>
              <div class="muted" style="margin-top:8px">${escapeHtml(it.pqc_note||"")}</div>
              <div class="muted" style="margin-top:8px"><b>Affected:</b> ${escapeHtml((it.affected||[]).length)} endpoint(s)</div>
              <pre class="mono">${escapeHtml(JSON.stringify(it.affected||[], null, 2))}</pre>
            </div>
          </details>
        `;
      }
      document.getElementById("tlsPlanOut").innerHTML = html;
    } catch(e) {
      console.error(e);
      document.getElementById("tlsPlanOut").innerHTML = `<div class="tiny muted">Failed: ${escapeHtml(String(e))}</div>`;
    }
  });

  // Initial load
  refreshHistory();
  setInterval(refreshHistory, 4000);
</script>
</body>
</html>
