<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PQC Scanner (TLS + Code) - Demo UI</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.68);
      --text:rgba(255,255,255,.92);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --accent: rgba(59,130,246,0.80);
      --good: rgba(34,197,94,0.85);
      --warn: rgba(245,158,11,0.90);
      --bad:  rgba(239,68,68,0.88);
      --crit: rgba(255, 51, 102, 0.95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(59,130,246,.20), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(236,72,153,.18), transparent 50%),
        radial-gradient(900px 700px at 70% 90%, rgba(34,197,94,.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1180px;
      margin: 28px auto;
      padding: 0 16px 60px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 18px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .sub{
      color:var(--muted);
      font-size: 13px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      margin-top: 12px;
    }
    @media(max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 15px;
      letter-spacing: .2px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="password"], textarea{
      width:100%;
      background: rgba(0,0,0,.20);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 11px;
      color: var(--text);
      outline:none;
    }
    textarea{
      min-height: 120px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      transition: .15s ease;
      font-weight: 600;
      font-size: 13px;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.11); }
    .btn.primary{
      background: rgba(59,130,246,.26);
      border-color: rgba(59,130,246,.30);
    }
    .btn.primary:hover{ background: rgba(59,130,246,.33); }
    .btn.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.22);
    }
    .btn.good{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.24);
    }
    .small{
      font-size: 12px;
      color: var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .status{
      min-height: 18px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      white-space: pre-wrap;
    }
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .kpi .pill strong{ color: var(--text); }
    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.15);
    }
    th, td{
      text-align:left;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      font-size: 12.5px;
      vertical-align: top;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      position: sticky;
      top: 0;
    }
    tr:hover td{ background: rgba(255,255,255,.02); }
    .mono{ font-family: var(--mono); font-size: 12px; }
    .sev{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .2px;
      border: 1px solid rgba(255,255,255,.10);
    }
    .sev.low{ background: rgba(34,197,94,.14); color: rgba(190,255,214,.95); border-color: rgba(34,197,94,.20); }
    .sev.medium{ background: rgba(245,158,11,.14); color: rgba(255,234,200,.95); border-color: rgba(245,158,11,.22); }
    .sev.high{ background: rgba(239,68,68,.14); color: rgba(255,210,210,.95); border-color: rgba(239,68,68,.22); }
    .sev.critical{ background: rgba(255, 51, 102, .18); color: rgba(255,220,232,.98); border-color: rgba(255,  51, 102, .25); }

    details.findings summary{
      cursor:pointer;
      list-style: none;
      display:flex;
      align-items:center;
      gap:8px;
      color: rgba(255,255,255,.88);
      font-weight: 700;
    }
    details.findings summary::-webkit-details-marker{ display:none; }
    .arrow{
      width: 18px;
      height: 18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      transform: rotate(0deg);
      transition: transform .15s ease;
    }
    details.findings[open] .arrow{ transform: rotate(90deg); }

    .findings-list{
      margin: 10px 0 0 0;
      padding: 0 0 0 18px;
    }
    .findings-list li{ margin: 10px 0; }

    .findings-meta{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }
    .findings-evidence{
      margin: 8px 0 0 0;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.85);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      max-width: 560px;
      overflow-x: auto;
      white-space: pre;
    }

    .progressWrap{
      display:none;
      margin-top:10px;
    }
    .progressLabel{
      font-size:12px;
      color: rgba(255,255,255,.70);
      margin-bottom: 6px;
    }
    .progressOuter{
      height: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: var(--accent);
      transition: width .2s ease;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width: 980px){
      .twoCol{ grid-template-columns: 1fr; }
    }

    .mutedBox{
      background: rgba(0,0,0,.18);
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 10px;
      color: var(--muted);
      font-size: 12px;
      white-space: pre-wrap;
      font-family: var(--mono);
      max-height: 320px;
      overflow:auto;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>PQC Scanner Platform (TLS + Code)</h1>
      <div class="sub">Progress • Auto refresh • Auto migration plan • Confidence • Evidence</div>
    </div>
    <div class="pill"><span class="mono">Backend:</span> <span id="backendBadge" class="mono">-</span></div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>1) Connect</h2>

      <div class="twoCol">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" type="text" placeholder="http://127.0.0.1:8000" />
        </div>
        <div>
          <label>API Key (x-api-key)</label>
          <input id="apiKey" type="password" placeholder="leave empty if backend key disabled" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn good" id="saveCfg">Save</button>
        <button class="btn" id="testHealth">Test /health</button>
        <div class="small">If backend env <span class="mono">PQC_API_KEY</span> is set, you must enter the same key here.</div>
      </div>

      <div class="status" id="connStatus"></div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.08); margin: 14px 0;"/>

      <h2>2) TLS Scan</h2>

      <div class="twoCol">
        <div>
          <label>Targets (one per line). Supports <span class="mono">host</span> or <span class="mono">host:port</span></label>
          <textarea id="targets" placeholder="google.com&#10;github.com&#10;example.com:443"></textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="runScan">Run TLS Scan</button>
            <button class="btn" id="refreshHistory">Refresh Recent Scans</button>
          </div>

          <div class="progressWrap" id="progressWrap">
            <div class="progressLabel" id="progressText"></div>
            <div class="progressOuter">
              <div class="progressBar" id="progressBar"></div>
            </div>
          </div>

          <div class="status" id="tlsStatus"></div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1;">
              <label>Load Scan ID</label>
              <input id="scanIdInput" class="mono" type="text" placeholder="paste scan id here"/>
            </div>
            <div style="display:flex;align-items:flex-end;gap:10px;">
              <button class="btn" id="loadScanBtn">Load</button>
              <button class="btn danger" id="clearBtn">Clear</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="loadMigrationBtn">TLS Migration Plan</button>
          </div>
        </div>

        <div>
          <label>Recent Scans</label>
          <div class="small">Click an ID to load it.</div>
          <table>
            <thead>
              <tr>
                <th style="width:220px;">id</th>
                <th style="width:100px;">status</th>
                <th style="width:170px;">created_at</th>
                <th>summary</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td colspan="4" class="small">No scans loaded yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.08); margin: 14px 0;"/>

      <h2>3) TLS Results</h2>
      <div class="kpi" id="kpis"></div>

      <table>
        <thead>
          <tr>
            <th style="width:160px;">host</th>
            <th style="width:70px;">port</th>
            <th>tls</th>
            <th>key</th>
            <th>sig</th>
            <th style="width:110px;">expiry</th>
            <th style="width:110px;">risk</th>
            <th style="width:110px;">PQC</th>
            <th>findings</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <tr><td colspan="9" class="small">Run a scan to see results.</td></tr>
        </tbody>
      </table>

      <div style="margin-top:12px;">
        <label>TLS Migration Plan Output</label>
        <div id="tlsPlanBox" class="mutedBox">(auto loads after scan completes, or click button)</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>4) Code Scan (ZIP)</h2>
      <div class="small">Upload a ZIP of a repo/project. Backend scans source files.</div>

      <div style="margin-top:10px;">
        <label>ZIP File</label>
        <input id="zipFile" type="file" accept=".zip"/>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="runCodeScan">Run Code Scan</button>
        <button class="btn" id="runCodePlan">Code Migration Plan</button>
      </div>

      <div class="status" id="codeStatus"></div>

      <div style="margin-top:12px;">
        <label>Code Findings</label>
        <table>
          <thead>
            <tr>
              <th style="width:110px;">severity</th>
              <th style="width:140px;">type</th>
              <th>file</th>
              <th style="width:90px;">line</th>
              <th>message</th>
            </tr>
          </thead>
          <tbody id="codeFindingsBody">
            <tr><td colspan="5" class="small">Upload a ZIP and run Code Scan.</td></tr>
          </tbody>
        </table>
      </div>

      <div style="margin-top:12px;">
        <label>Code Migration Plan Output</label>
        <div id="codePlanBox" class="mutedBox">(run “Code Migration Plan” to see recommended actions)</div>
      </div>
    </div>
  </div>
</div>

<script>
  const apiBaseEl = document.getElementById("apiBase");
  const apiKeyEl  = document.getElementById("apiKey");
  const backendBadge = document.getElementById("backendBadge");
  const connStatus = document.getElementById("connStatus");

  const targetsEl = document.getElementById("targets");
  const tlsStatus = document.getElementById("tlsStatus");
  const scanIdInput = document.getElementById("scanIdInput");

  const progressWrap = document.getElementById("progressWrap");
  const progressText = document.getElementById("progressText");
  const progressBar  = document.getElementById("progressBar");

  const historyBody = document.getElementById("historyBody");
  const kpisEl = document.getElementById("kpis");
  const resultsBody = document.getElementById("resultsBody");
  const tlsPlanBox = document.getElementById("tlsPlanBox");

  const zipFileEl = document.getElementById("zipFile");
  const codeStatus = document.getElementById("codeStatus");
  const codeFindingsBody = document.getElementById("codeFindingsBody");
  const codePlanBox = document.getElementById("codePlanBox");

  let API_BASE = localStorage.getItem("PQC_API_BASE") || "http://127.0.0.1:8000";
  let API_KEY  = localStorage.getItem("PQC_API_KEY")  || "";
  let lastScanId = "";

  apiBaseEl.value = API_BASE;
  apiKeyEl.value = API_KEY;
  backendBadge.textContent = API_BASE;

  function setConn(msg){ connStatus.textContent = msg || ""; }
  function setTLS(msg){ tlsStatus.textContent = msg || ""; }
  function setCode(msg){ codeStatus.textContent = msg || ""; }

  function apiUrl(path){
    return (API_BASE || "").replace(/\/+$/,"") + path;
  }

  async function apiFetch(url, opts){
    const o = opts || {};
    o.headers = o.headers || {};
    if (API_KEY && !o.headers["x-api-key"]) o.headers["x-api-key"] = API_KEY;
    return fetch(url, o);
  }

  function sevClass(sev){
    const s = (sev || "").toLowerCase();
    if (s.includes("critical")) return "critical";
    if (s.includes("high")) return "high";
    if (s.includes("medium")) return "medium";
    return "low";
  }

  // ---------------------------
  // Progress polling (FIXED + AUTO LOAD PLAN)
  // ---------------------------
  let progressTimer = null;

  function stopProgress(){
    if (progressTimer) clearInterval(progressTimer);
    progressTimer = null;
    progressWrap.style.display = "none";
    progressBar.style.width = "0%";
    progressText.textContent = "";
  }

  async function pollProgress(scanId){
    stopProgress();

    progressWrap.style.display = "block";
    progressText.textContent = "Progress: 0% (done 0/?) — status: starting";
    progressBar.style.width = "0%";

    async function tick(){
      try{
        const res = await apiFetch(apiUrl("/scans/" + encodeURIComponent(scanId)), {method:"GET"});
        if(!res.ok){
          if(res.status === 401){
            progressText.textContent = "Progress: 401 Unauthorized (check API key)";
          } else {
            progressText.textContent = `Progress: error ${res.status}`;
          }
          return;
        }

        const data = await res.json();
        const status = data.status || "unknown";
        const prog = data.progress || {};
        const total = prog.total ?? 0;
        const done = prog.done ?? 0;
        const percent = prog.percent ?? 0;

        progressBar.style.width = (percent || 0) + "%";
        progressText.textContent = `Progress: ${percent || 0}% (done ${done}/${total || "?"}) — status: ${status}`;

        // Auto refresh results during scan
        if(status === "running"){
          await fetchTLSScanResults(scanId, true);
          return;
        }

        // Completed: load final results + history + migration plan
        if(status === "completed"){
          await fetchTLSScanResults(scanId, false);
          await fetchHistory();
          await loadTLSMigrationPlan(scanId); // ✅ AUTO LOAD
          stopProgress();
        } else if(status === "failed"){
          await fetchTLSScanResults(scanId, false);
          await fetchHistory();
          stopProgress();
        }
      } catch(e){
        // ignore transient errors
      }
    }

    await tick(); // immediate first tick
    progressTimer = setInterval(tick, 1000);
  }

  // ---------------------------
  // Connect controls
  // ---------------------------
  document.getElementById("saveCfg").onclick = () => {
    API_BASE = apiBaseEl.value.trim() || "http://127.0.0.1:8000";
    API_KEY = apiKeyEl.value.trim();
    localStorage.setItem("PQC_API_BASE", API_BASE);
    localStorage.setItem("PQC_API_KEY", API_KEY);
    backendBadge.textContent = API_BASE;
    setConn("Saved.");
  };

  document.getElementById("testHealth").onclick = async () => {
    API_BASE = apiBaseEl.value.trim() || "http://127.0.0.1:8000";
    API_KEY = apiKeyEl.value.trim();
    backendBadge.textContent = API_BASE;
    try{
      const res = await fetch(apiUrl("/health"));
      const data = await res.json();
      setConn("Health OK: " + JSON.stringify(data));
    }catch(e){
      setConn("Health failed. Is backend running? " + e);
    }
  };

  // ---------------------------
  // Recent scans
  // ---------------------------
  async function fetchHistory(){
    try{
      const res = await apiFetch(apiUrl("/scans?limit=20"), {method:"GET"});
      if(!res.ok){
        historyBody.innerHTML = `<tr><td colspan="4" class="small">Failed to load scans (${res.status}).</td></tr>`;
        return;
      }
      const rows = await res.json();
      if(!rows || !rows.length){
        historyBody.innerHTML = `<tr><td colspan="4" class="small">No scans yet.</td></tr>`;
        return;
      }
      historyBody.innerHTML = rows.map(r => {
        const sum = r.summary || {};
        const summaryText = `total=${sum.total ?? "-"}, high=${sum.high ?? "-"}, qscore=${sum.quantum_risk_score ?? "-"}`;
        return `
          <tr>
            <td class="mono"><a href="#" data-id="${r.id}" style="color:rgba(147,197,253,.95); text-decoration:none;">${r.id}</a></td>
            <td class="mono">${r.status}</td>
            <td class="mono">${(r.created_at || "").replace("T"," ").replace("Z","")}</td>
            <td class="mono">${summaryText}</td>
          </tr>
        `;
      }).join("");

      historyBody.querySelectorAll("a[data-id]").forEach(a => {
        a.onclick = async (ev) => {
          ev.preventDefault();
          const id = a.getAttribute("data-id");
          if(!id) return;
          scanIdInput.value = id;
          lastScanId = id;
          setTLS("Loading scan " + id + " ...");
          await fetchTLSScanResults(id, false);
          pollProgress(id); // show progress if running
        };
      });
    }catch(e){
      historyBody.innerHTML = `<tr><td colspan="4" class="small">History error: ${String(e)}</td></tr>`;
    }
  }

  // ---------------------------
  // TLS scan create
  // ---------------------------
  async function runTLSScan(){
    stopProgress();
    tlsPlanBox.textContent = "(auto loads after scan completes, or click button)";
    kpisEl.innerHTML = "";
    resultsBody.innerHTML = `<tr><td colspan="9" class="small">Starting scan...</td></tr>`;

    API_BASE = apiBaseEl.value.trim() || "http://127.0.0.1:8000";
    API_KEY = apiKeyEl.value.trim();
    backendBadge.textContent = API_BASE;

    const targets = (targetsEl.value || "")
      .split("\n").map(s => s.trim()).filter(Boolean);

    if(!targets.length){
      setTLS("Add at least one target.");
      return;
    }

    setTLS("Creating scan...");
    try{
      const res = await apiFetch(apiUrl("/scans"), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({targets})
      });

      if(!res.ok){
        const text = await res.text();
        setTLS(`Failed to create scan (${res.status}). ${text}`);
        resultsBody.innerHTML = `<tr><td colspan="9" class="small">Scan failed.</td></tr>`;
        return;
      }

      const data = await res.json();
      lastScanId = data.id;
      scanIdInput.value = lastScanId;
      setTLS("Scan started: " + lastScanId);

      await fetchHistory();
      pollProgress(lastScanId); // ✅ show progress + auto refresh + auto plan

    }catch(e){
      setTLS("Failed to create scan. Is the backend running? " + e);
      resultsBody.innerHTML = `<tr><td colspan="9" class="small">Scan failed.</td></tr>`;
    }
  }

  async function fetchTLSScanResults(scanId, silent){
    try{
      const res = await apiFetch(apiUrl("/scans/" + encodeURIComponent(scanId) + "/results"), {method:"GET"});
      if(!res.ok){
        if(!silent) setTLS(`Failed to load scan results (${res.status}).`);
        return;
      }
      const data = await res.json();
      const results = data.results || [];
      const summary = data.summary || {};
      if(!silent){
        setTLS(`Loaded scan ${scanId} (status=${data.status}, results=${results.length}).`);
      }
      renderKPIs(summary);
      renderTLSResults(results);
    }catch(e){
      if(!silent) setTLS("Error loading results: " + e);
    }
  }

  async function loadTLSMigrationPlan(scanId){
    tlsPlanBox.textContent = "Loading TLS migration plan...";
    try{
      const res = await apiFetch(apiUrl("/scans/" + encodeURIComponent(scanId) + "/migration-plan"), {method:"GET"});
      if(!res.ok){
        const t = await res.text();
        tlsPlanBox.textContent = `Failed (${res.status}): ${t}`;
        return;
      }
      const plan = await res.json();
      tlsPlanBox.textContent = JSON.stringify(plan, null, 2);
    }catch(e){
      tlsPlanBox.textContent = "Error: " + e;
    }
  }

  function renderKPIs(summary){
    if(!summary || typeof summary !== "object"){
      kpisEl.innerHTML = "";
      return;
    }
    const pills = [
      ["total", summary.total],
      ["high", summary.high],
      ["medium", summary.medium],
      ["low", summary.low],
      ["errors", summary.errors],
      ["RSA", summary.rsa_count],
      ["qScore", summary.quantum_risk_score],
      ["qLevel", summary.quantum_risk_level],
    ];
    kpisEl.innerHTML = pills.map(([k,v]) => `
      <div class="pill"><span class="mono">${k}:</span> <strong class="mono">${(v==null?"-":v)}</strong></div>
    `).join("");
  }

  function renderTLSResults(results){
    if(!results || !results.length){
      resultsBody.innerHTML = `<tr><td colspan="9" class="small">No results yet (scan running or empty).</td></tr>`;
      return;
    }

    resultsBody.innerHTML = results.map(r => {
      const host = r.host || "";
      const port = r.port == null ? "" : r.port;
      const tls = r.tls_version || (r.tls_supported_versions ? (r.tls_supported_versions.join(",") || "-") : "-");
      const key = (r.key_type || "-") + (r.key_detail ? (" / " + r.key_detail) : "");
      const sig = r.sig_algorithm || "-";
      const expiry = (r.days_until_expiry != null ? (r.days_until_expiry + "d") : "-");
      const risk = r.risk_level || r.risk || "-";
      const findings = r.findings || [];

      const riskClass = sevClass(risk);
      const pqcClass = sevClass(r.pqc_relevance || "");

      const findingsHtml = findings.length ? `
        <details class="findings">
          <summary><span class="arrow">›</span><span class="mono">${findings.length} finding(s)</span></summary>
          <ol class="findings-list">
            ${findings.map(f => {
              const sev = (f.severity || "").toUpperCase();
              const title = (f.title || f.message || f.rule_id || "Finding");
              const rid = (f.rule_id || "");
              const fix = (f.remediation || f.recommendation || "");

              const conf = (f.confidence || f.confidence_level || "");
              const confReason = (f.confidence_reason || "");
              const evidence = (f.evidence || {});

              let evText = "";
              try{
                if(evidence && Object.keys(evidence).length){
                  evText = JSON.stringify(evidence, null, 2);
                }
              }catch(e){ evText = ""; }

              const confLine = conf ? `
                <div class="findings-meta"><strong>Confidence:</strong> ${conf}${confReason ? " — " + confReason : ""}</div>
              ` : "";

              const evBlock = evText ? `<pre class="findings-evidence">${evText}</pre>` : "";

              return `
                <li>
                  <strong>${sev}</strong> ${title}
                  <div class="findings-meta">${rid}${fix ? " • Fix: " + fix : ""}</div>
                  ${confLine}
                  ${evBlock}
                </li>
              `;
            }).join("")}
          </ol>
        </details>
      ` : `<span class="small">—</span>`;

      return `
        <tr>
          <td class="mono">${host}</td>
          <td class="mono">${port}</td>
          <td class="mono">${tls}</td>
          <td class="mono">${key}</td>
          <td class="mono">${sig}</td>
          <td class="mono">${expiry}</td>
          <td><span class="sev ${riskClass}">${String(risk).toUpperCase()}</span></td>
          <td><span class="sev ${pqcClass}">${String(r.pqc_relevance || "-").toUpperCase()}</span></td>
          <td>${findingsHtml}</td>
        </tr>
      `;
    }).join("");
  }

  // Buttons
  document.getElementById("runScan").onclick = runTLSScan;
  document.getElementById("refreshHistory").onclick = fetchHistory;

  document.getElementById("loadScanBtn").onclick = async () => {
    const id = (scanIdInput.value || "").trim();
    if(!id){ setTLS("Paste a scan id first."); return; }
    lastScanId = id;
    setTLS("Loading scan " + id + " ...");
    await fetchTLSScanResults(id, false);
    pollProgress(id);
  };

  document.getElementById("loadMigrationBtn").onclick = async () => {
    const id = (scanIdInput.value || lastScanId || "").trim();
    if(!id){ setTLS("Load a scan ID first."); return; }
    await loadTLSMigrationPlan(id);
  };

  document.getElementById("clearBtn").onclick = () => {
    stopProgress();
    lastScanId = "";
    scanIdInput.value = "";
    setTLS("");
    kpisEl.innerHTML = "";
    tlsPlanBox.textContent = "(auto loads after scan completes, or click button)";
    resultsBody.innerHTML = `<tr><td colspan="9" class="small">Cleared. Run a scan to see results.</td></tr>`;
  };

  // Code scan
  async function postZip(endpoint){
    const f = (zipFileEl.files && zipFileEl.files[0]) ? zipFileEl.files[0] : null;
    if(!f){
      setCode("Select a .zip file first.");
      return null;
    }
    const fd = new FormData();
    fd.append("archive", f);

    const res = await apiFetch(apiUrl(endpoint), {method:"POST", body: fd});
    if(!res.ok){
      const t = await res.text();
      setCode(`Failed (${res.status}): ${t}`);
      return null;
    }
    return res.json();
  }

  function renderCodeFindings(findings){
    if(!findings || !findings.length){
      codeFindingsBody.innerHTML = `<tr><td colspan="5" class="small">No findings.</td></tr>`;
      return;
    }
    codeFindingsBody.innerHTML = findings.map(f => {
      const sev = (f.severity || "").toLowerCase();
      const type = f.type || f.rule_id || "-";
      const file = f.file || f.path || "-";
      const line = (f.line == null ? "-" : f.line);
      const msg = f.message || f.title || "-";
      return `
        <tr>
          <td><span class="sev ${sevClass(sev)}">${(sev || "low").toUpperCase()}</span></td>
          <td class="mono">${String(type)}</td>
          <td class="mono">${String(file)}</td>
          <td class="mono">${String(line)}</td>
          <td>${String(msg)}</td>
        </tr>
      `;
    }).join("");
  }

  document.getElementById("runCodeScan").onclick = async () => {
    setCode("Uploading ZIP and scanning...");
    codePlanBox.textContent = "(run “Code Migration Plan” to see recommended actions)";
    const data = await postZip("/code-scan");
    if(!data) return;
    setCode(`Code scan OK. Findings: ${data.count ?? (data.findings ? data.findings.length : 0)}`);
    renderCodeFindings(data.findings || []);
  };

  document.getElementById("runCodePlan").onclick = async () => {
    setCode("Uploading ZIP and building migration plan...");
    const plan = await postZip("/code-scan/migration-plan");
    if(!plan) return;
    setCode("Code migration plan OK.");
    codePlanBox.textContent = JSON.stringify(plan, null, 2);
  };

  // initial load
  fetchHistory();
</script>

</body>
</html>
