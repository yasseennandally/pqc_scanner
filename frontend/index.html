<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PQC TLS Scanner</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f172a;
      --text:#e6e9f2;
      --muted:#a7b0c3;
      --border:#223055;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background: radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.25), transparent),
      radial-gradient(900px 600px at 90% 0%, rgba(34,197,94,.18), transparent),
      var(--bg);
      color:var(--text);
    }
    header{
      padding:22px 22px 10px;
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px}
    .pill{
      padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted);
      background: rgba(16,26,51,.6);
    }
    main{max-width:1200px; margin:0 auto; padding:12px 22px 28px; display:flex; flex-direction:column; gap:14px;}
    .grid{
      display:grid; grid-template-columns: 420px 1fr; gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }
    .card{
      background: linear-gradient(180deg, rgba(16,26,51,.9), rgba(16,26,51,.65));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px; font-size:14px; font-weight:650; letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .muted{color:var(--muted)}
    textarea{
      width:100%; min-height:180px; resize:vertical;
      background: rgba(15,23,42,.9);
      color: var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.4;
      outline:none;
    }
    input[type="text"]{
      width:100%;
      background: rgba(15,23,42,.9);
      color: var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-family: var(--mono);
      font-size: 12px;
      outline:none;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      appearance:none; border:1px solid var(--border);
      background: rgba(124,58,237,.18);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:650;
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{border-color: rgba(124,58,237,.6); background: rgba(124,58,237,.25);}
    .btn:active{transform: translateY(1px);}
    .btn.secondary{background: rgba(34,197,94,.14);}
    .btn.secondary:hover{border-color: rgba(34,197,94,.6); background: rgba(34,197,94,.22);}
    .btn.ghost{background: transparent;}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .small{font-size:12px}
    .kvs{
      display:grid; grid-template-columns: 140px 1fr;
      gap:8px 12px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .kvs strong{color: var(--text); font-weight:650}
    .progressWrap{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      height:12px;
      background: rgba(15,23,42,.9);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(124,58,237,.9), rgba(34,197,94,.85));
      transition: width .25s ease;
    }
    .statusLine{margin-top:8px; font-size:12px; color: var(--muted); display:flex; justify-content:space-between; gap:10px;}
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--border);
    }
    th, td{
      padding:10px 10px;
      border-bottom: 1px solid rgba(34,48,85,.7);
      vertical-align: top;
    }
    th{
      text-align:left;
      font-size: 11px;
      color: var(--muted);
      letter-spacing:.3px;
      background: rgba(15,23,42,.85);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover td{background: rgba(15,23,42,.45);}
    .risk{
      display:inline-flex; align-items:center; gap:7px;
      padding:5px 10px;
      border-radius:999px;
      font-weight:700;
      border:1px solid var(--border);
      background: rgba(15,23,42,.65);
      font-size:11px;
    }
    .risk.critical{border-color: rgba(239,68,68,.6); color: #fecaca; background: rgba(239,68,68,.12);}
    .risk.high{border-color: rgba(245,158,11,.65); color: #fde68a; background: rgba(245,158,11,.12);}
    .risk.medium{border-color: rgba(59,130,246,.65); color: #bfdbfe; background: rgba(59,130,246,.12);}
    .risk.low{border-color: rgba(34,197,94,.55); color: #bbf7d0; background: rgba(34,197,94,.10);}
    details{
      border:1px solid rgba(34,48,85,.75);
      background: rgba(15,23,42,.6);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0;
    }
    details > summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details > summary::-webkit-details-marker{display:none}
    .chev{
      width:18px; height:18px; border-radius:6px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(34,48,85,.9);
      color: var(--muted);
      background: rgba(16,26,51,.6);
      font-family: var(--mono);
      font-size: 12px;
    }
    details[open] .chev{color: var(--text)}
    .finding{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(34,48,85,.75);
      background: rgba(11,16,32,.45);
    }
    .finding .topline{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      background: rgba(16,26,51,.6);
    }
    .sev{
      font-weight:800;
      letter-spacing:.2px;
      font-size:11px;
    }
    .sev.critical{color:#fecaca}
    .sev.high{color:#fde68a}
    .sev.medium{color:#bfdbfe}
    .sev.low{color:#bbf7d0}
    .mono{font-family: var(--mono)}
    pre{
      margin:8px 0 0;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(34,48,85,.75);
      background: rgba(0,0,0,.18);
      overflow:auto;
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.4;
      color: #dbeafe;
    }
    .planItem{
      padding:10px;
      border:1px solid rgba(34,48,85,.75);
      border-radius:12px;
      background: rgba(11,16,32,.45);
      margin-top:10px;
    }
    .planItem h4{margin:0 0 6px; font-size:12px}
    .planItem ul{margin:6px 0 0 18px; color: var(--muted); font-size:12px}
    .rightHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>PQC TLS Scanner</h1>
      <div class="subtitle">Scan endpoints, see findings with evidence, and generate an ordered TLS migration checklist.</div>
    </div>
    <div class="pill mono">API: <span id="apiBaseLabel"></span></div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>
          Scan Targets
          <span class="muted small">one per line</span>
        </h2>

        <textarea id="targets" spellcheck="false">google.com
facebook.com
badssl.com
incomplete-chain.badssl.com</textarea>

        <div class="row" style="margin-top:10px">
          <button id="startBtn" class="btn">Start scan</button>
          <button id="loadLastBtn" class="btn ghost">Load last scan</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>

        <div style="margin-top:12px">
          <div class="muted small">Optional API Key (x-api-key)</div>
          <input id="apiKey" type="text" placeholder="(empty = no auth)" />
        </div>

        <div class="progressWrap" title="Progress">
          <div id="progressBar" class="bar"></div>
        </div>
        <div class="statusLine">
          <div id="statusText">Idle</div>
          <div id="progressText">0%</div>
        </div>

        <div class="kvs">
          <div>Scan ID</div><div><strong id="scanId">—</strong></div>
          <div>Completed</div><div><strong id="doneCounts">—</strong></div>
          <div>Quantum score</div><div><strong id="quantumScore">—</strong></div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="planBtn" class="btn secondary" disabled>Generate TLS Migration Plan</button>
        </div>
        <div id="planBox"></div>
      </section>

      <section class="card">
        <div class="rightHeader">
          <h2 style="margin:0">Results</h2>
          <div class="row">
            <button id="refreshBtn" class="btn ghost" disabled>Refresh</button>
            <button id="jsonBtn" class="btn ghost" disabled>View JSON</button>
          </div>
        </div>

        <div style="overflow:auto; max-height: 70vh;">
          <table>
            <thead>
              <tr>
                <th style="width:36px;"></th>
                <th>host</th>
                <th>port</th>
                <th>tls</th>
                <th>key</th>
                <th>sig</th>
                <th>expiry</th>
                <th>risk</th>
                <th>PQC</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <tr><td colspan="9" class="muted">No results yet.</td></tr>
            </tbody>
          </table>
        </div>
        <div id="jsonModal" style="display:none; margin-top:12px"></div>
      </section>
    </div>
  </main>

  <script>
    const API_BASE = (localStorage.getItem("PQC_API_BASE") || "http://127.0.0.1:8000").replace(/\/+$/,"");
    document.getElementById("apiBaseLabel").textContent = API_BASE;

    function headers() {
      const key = document.getElementById("apiKey").value.trim();
      const h = {"Content-Type":"application/json"};
      if (key) h["x-api-key"] = key;
      return h;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function riskBadge(level){
      const lv = (level||"low").toLowerCase();
      return `<span class="risk ${lv}">${escapeHtml(lv.toUpperCase())}</span>`;
    }

    function fmtExpiry(days){
      if (days === null || days === undefined) return "—";
      const d = Number(days);
      if (Number.isNaN(d)) return "—";
      return `${d}d`;
    }

    function sevClass(sev){
      sev = (sev||"low").toLowerCase();
      return sev;
    }

    function findingHtml(f){
      const sev = (f.severity||"low").toLowerCase();
      const rid = f.rule_id || "";
      const title = f.title || "";
      const fix = f.fix || "";
      const conf = f.confidence || "";
      const confR = f.confidence_reason || "";
      const pqc = f.pqc_note || "";
      const evidence = f.evidence || {};

      return `
        <div class="finding">
          <div class="topline">
            <div>
              <span class="sev ${sevClass(sev)}">${escapeHtml(sev.toUpperCase())}</span>
              <span style="margin-left:8px; font-weight:750;">${escapeHtml(title)}</span>
            </div>
            <span class="badge">${escapeHtml(rid)}</span>
          </div>
          <div class="muted" style="font-size:12px; margin-top:6px;">
            <strong>Fix:</strong> ${escapeHtml(fix)}
          </div>
          <div class="muted" style="font-size:12px; margin-top:6px;">
            <strong>Confidence:</strong> <span class="mono">${escapeHtml(conf)}</span>${confR ? " — " + escapeHtml(confR) : ""}
          </div>
          ${pqc ? `<div class="muted" style="font-size:12px; margin-top:6px;"><strong>PQC:</strong> ${escapeHtml(pqc)}</div>` : ""}
          <pre>${escapeHtml(JSON.stringify(evidence, null, 2))}</pre>
        </div>
      `;
    }

    function chainHtml(r){
      const chain = r.cert_chain || [];
      const rows = chain.map(c => `
        <tr>
          <td class="mono">${escapeHtml(c.index)}</td>
          <td>${escapeHtml(c.subject || "")}</td>
          <td>${escapeHtml(c.issuer || "")}</td>
          <td class="mono">${escapeHtml(c.not_before || "")}</td>
          <td class="mono">${escapeHtml(c.not_after || "")}</td>
          <td class="mono">${escapeHtml((c.key_type||"") + (c.key_detail ? " / " + c.key_detail : ""))}</td>
          <td class="mono">${escapeHtml(c.sig_algorithm || "")}</td>
          <td class="mono">${escapeHtml((c.fingerprint_sha256 || c.serial_hex || "").slice(0, 18))}…</td>
        </tr>
      `).join("");

      return `
        <details>
          <summary>
            <span>Certificate chain</span>
            <span class="chev">›</span>
          </summary>
          <div class="kvs" style="margin-top:10px">
            <div>chain_length</div><div><strong>${escapeHtml(r.chain_length)}</strong></div>
            <div>chain_issues</div><div><strong>${escapeHtml(r.chain_issues)}</strong></div>
            <div>chain_source</div><div><strong class="mono">${escapeHtml(r.chain_source)}</strong></div>
            <div>confidence</div><div><strong class="mono">${escapeHtml(r.chain_confidence || "")}</strong></div>
            <div>note</div><div>${escapeHtml(r.chain_confidence_reason || "")}</div>
          </div>

          <div style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>subject</th><th>issuer</th><th>not_before</th><th>not_after</th><th>key</th><th>sig</th><th>fp/serial</th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="8" class="muted">No chain details returned.</td></tr>`}
              </tbody>
            </table>
          </div>
        </details>
      `;
    }

    function certExtensionsHtml(r){
      const san = r.san_dns || [];
      const ku = r.key_usage || {};
      const eku = r.eku || [];
      const ocsp = r.ocsp_urls || [];
      const crl = r.crl_urls || [];
      const cai = r.ca_issuers_urls || [];

      return `
        <details>
          <summary>
            <span>Certificate extensions</span>
            <span class="chev">›</span>
          </summary>

          <div class="kvs" style="margin-top:10px">
            <div>subject</div><div class="mono"><strong>${escapeHtml(r.subject || "")}</strong></div>
            <div>issuer</div><div class="mono"><strong>${escapeHtml(r.issuer || "")}</strong></div>
            <div>SAN (DNS)</div><div class="mono">${escapeHtml(san.join(", ") || "—")}</div>
            <div>KeyUsage</div><div class="mono">${escapeHtml(Object.keys(ku).filter(k=>ku[k]).join(", ") || "—")}</div>
            <div>EKU</div><div class="mono">${escapeHtml(eku.join(", ") || "—")}</div>
            <div>OCSP URLs (AIA)</div><div class="mono">${escapeHtml(ocsp.join(", ") || "—")}</div>
            <div>CA Issuers (AIA)</div><div class="mono">${escapeHtml(cai.join(", ") || "—")}</div>
            <div>CRL URLs</div><div class="mono">${escapeHtml(crl.join(", ") || "—")}</div>
            <div>OCSP stapled</div><div class="mono"><strong>${escapeHtml(String(r.ocsp_stapled))}</strong> <span class="muted">${escapeHtml(r.ocsp_stapling_probe || "")}</span></div>
          </div>
        </details>
      `;
    }

    function findingsSectionHtml(r){
      const list = r.findings || [];
      const items = list.map(f => findingHtml(f)).join("");
      return `
        <details open>
          <summary>
            <span>${list.length} finding(s)</span>
            <span class="chev">›</span>
          </summary>
          ${items || `<div class="muted" style="margin-top:10px">No findings.</div>`}
        </details>
      `;
    }

    function detailsHtml(r){
      return `
        ${findingsSectionHtml(r)}
        ${certExtensionsHtml(r)}
        ${chainHtml(r)}
      `;
    }

    function rowHtml(r, idx){
      const hp = `${r.host || ""}`;
      const tls = r.tls_version || "—";
      const key = (r.key_type || "—") + (r.key_detail ? " / " + r.key_detail : "");
      const sig = r.sig_algorithm || "—";
      const exp = fmtExpiry(r.days_until_expiry);
      const risk = riskBadge(r.risk || r.risk_level || "low");
      const pqc = (r.pqc_relevance || "—");

      const summaryCell = `
        <div class="muted small">
          ${r.error ? `<span class="mono">${escapeHtml(r.error)}</span>` : ""}
          ${r.verify_error ? `<div>verify_error: <span class="mono">${escapeHtml(r.verify_error)}</span></div>` : ""}
        </div>
      `;

      return `
        <tr>
          <td>
            <details>
              <summary><span class="chev">›</span></summary>
              ${detailsHtml(r)}
            </details>
          </td>
          <td class="mono">${escapeHtml(hp)}</td>
          <td class="mono">${escapeHtml(r.port)}</td>
          <td class="mono">${escapeHtml(tls)}</td>
          <td class="mono">${escapeHtml(key)}</td>
          <td class="mono">${escapeHtml(sig)}</td>
          <td class="mono">${escapeHtml(exp)}</td>
          <td>${risk}</td>
          <td class="mono">${escapeHtml(pqc)}</td>
        </tr>
      `;
    }

    function setProgress(prog){
      const bar = document.getElementById("progressBar");
      const pct = prog?.percent ?? 0;
      bar.style.width = `${pct}%`;
      document.getElementById("progressText").textContent = `${pct}%`;
      const done = prog?.done ?? 0;
      const total = prog?.total ?? 0;
      document.getElementById("doneCounts").textContent = `${done}/${total}`;
    }

    function setStatus(text){
      document.getElementById("statusText").textContent = text;
    }

    function setSummary(summary){
      if (!summary || Object.keys(summary).length === 0){
        document.getElementById("quantumScore").textContent = "—";
        return;
      }
      document.getElementById("quantumScore").textContent = `${summary.quantum_risk_score ?? "—"} (${summary.quantum_risk_level ?? "—"})`;
    }

    let currentScanId = null;
    let lastResults = null;

    async function startScan(){
      const lines = document.getElementById("targets").value.split("\n").map(s=>s.trim()).filter(Boolean);
      if (!lines.length){
        alert("Add at least one target.");
        return;
      }
      setStatus("Starting scan…");
      document.getElementById("resultsBody").innerHTML = `<tr><td colspan="9" class="muted">Starting…</td></tr>`;
      document.getElementById("planBox").innerHTML = "";
      document.getElementById("planBtn").disabled = true;
      document.getElementById("refreshBtn").disabled = true;
      document.getElementById("jsonBtn").disabled = true;

      const res = await fetch(`${API_BASE}/scans`, {
        method:"POST",
        headers: headers(),
        body: JSON.stringify({targets: lines})
      });

      if (!res.ok){
        const t = await res.text();
        throw new Error(`Failed to start scan: ${t}`);
      }
      const data = await res.json();
      currentScanId = data.id;
      localStorage.setItem("PQC_LAST_SCAN_ID", currentScanId);
      document.getElementById("scanId").textContent = currentScanId;
      setProgress(data.progress);
      setStatus(`Running (${data.progress.done}/${data.progress.total})…`);

      document.getElementById("refreshBtn").disabled = false;
      pollProgress();
    }

    async function pollProgress(){
      if (!currentScanId) return;
      while(true){
        const st = await fetch(`${API_BASE}/scans/${currentScanId}`, {headers: headers()});
        if (!st.ok) break;
        const status = await st.json();

        setProgress(status.progress);
        setStatus(`${status.status} (${status.progress.done}/${status.progress.total})`);

        if (status.status === "completed" || status.status === "failed"){
          await loadResults();
          document.getElementById("planBtn").disabled = false;
          document.getElementById("jsonBtn").disabled = false;
          return;
        }
        await new Promise(r=>setTimeout(r, 700));
      }
    }

    async function loadResults(){
      if (!currentScanId) return;
      const res = await fetch(`${API_BASE}/scans/${currentScanId}/results`, {headers: headers()});
      if (!res.ok){
        const t = await res.text();
        throw new Error(`Failed to load results: ${t}`);
      }
      const data = await res.json();
      lastResults = data;

      setProgress(data.progress);
      setSummary(data.summary);

      const results = data.results || [];
      if (!results.length){
        document.getElementById("resultsBody").innerHTML = `<tr><td colspan="9" class="muted">No results returned.</td></tr>`;
      } else {
        document.getElementById("resultsBody").innerHTML = results.map((r,i)=>rowHtml(r,i)).join("");
      }
      document.getElementById("refreshBtn").disabled = false;
      document.getElementById("jsonBtn").disabled = false;
    }

    async function loadLastScan(){
      const sid = localStorage.getItem("PQC_LAST_SCAN_ID");
      if (!sid){
        alert("No previous scan id found.");
        return;
      }
      currentScanId = sid;
      document.getElementById("scanId").textContent = sid;
      setStatus("Loading last scan…");
      await loadResults();
      document.getElementById("planBtn").disabled = false;
    }

    async function buildPlan(){
      if (!currentScanId) return;
      document.getElementById("planBox").innerHTML = `<div class="muted" style="margin-top:10px">Generating…</div>`;
      const res = await fetch(`${API_BASE}/scans/${currentScanId}/migration-plan`, {headers: headers()});
      if (!res.ok){
        const t = await res.text();
        document.getElementById("planBox").innerHTML = `<div class="muted" style="margin-top:10px">Error: ${escapeHtml(t)}</div>`;
        return;
      }
      const data = await res.json();
      const items = data.items || [];
      if (!items.length){
        document.getElementById("planBox").innerHTML = `<div class="muted" style="margin-top:10px">No plan items returned.</div>`;
        return;
      }
      document.getElementById("planBox").innerHTML = items.map(it => `
        <div class="planItem">
          <h4>${escapeHtml(it.step || "")} <span class="badge" style="margin-left:8px">${escapeHtml(it.rule_id || "")}</span></h4>
          <div class="muted" style="font-size:12px">${escapeHtml(it.why || "")}</div>
          <ul>
            ${(it.affected || []).slice(0, 12).map(a=>`<li class="mono">${escapeHtml(a)}</li>`).join("")}
            ${(it.affected || []).length > 12 ? `<li class="muted">…and more</li>` : ""}
          </ul>
          ${(it.evidence_samples && it.evidence_samples.length) ? `<pre>${escapeHtml(JSON.stringify(it.evidence_samples, null, 2))}</pre>` : ""}
        </div>
      `).join("");
    }

    function viewJson(){
      if (!lastResults){
        alert("No results to show.");
        return;
      }
      const box = document.getElementById("jsonModal");
      if (box.style.display === "none"){
        box.style.display = "block";
        box.innerHTML = `<pre>${escapeHtml(JSON.stringify(lastResults, null, 2))}</pre>`;
      } else {
        box.style.display = "none";
        box.innerHTML = "";
      }
    }

    document.getElementById("startBtn").addEventListener("click", async () => {
      try{
        document.getElementById("startBtn").disabled = true;
        await startScan();
      } catch(e){
        alert(String(e));
        setStatus("Error");
      } finally {
        document.getElementById("startBtn").disabled = false;
      }
    });
    document.getElementById("refreshBtn").addEventListener("click", async () => {
      try{ await loadResults(); } catch(e){ alert(String(e)); }
    });
    document.getElementById("planBtn").addEventListener("click", async () => {
      await buildPlan();
    });
    document.getElementById("loadLastBtn").addEventListener("click", async () => {
      try{ await loadLastScan(); } catch(e){ alert(String(e)); }
    });
    document.getElementById("jsonBtn").addEventListener("click", () => viewJson());
    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("targets").value = "";
    });

    // Auto-load last scan if present
    (async function init(){
      const sid = localStorage.getItem("PQC_LAST_SCAN_ID");
      if (sid){
        currentScanId = sid;
        document.getElementById("scanId").textContent = sid;
        try{
          await loadResults();
          document.getElementById("planBtn").disabled = false;
        } catch(_){}
      }
    })();
  </script>
</body>
</html>
